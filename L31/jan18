import sys
import threading 

try:
    import pyaudio
    import numpy as np
    import matplotlib.pyplot as plt
    import speech_recognition as sr
    from speech_recognition import AudioData
except ImportError as e :
    print(f"Misisng Library :{e.name}")
    print("\n Install using:")
    print("Winfows: pip install SpechRecognition")
    print("macOS: brew install portaudio && pip install SpeechRecognition pyaudio numpy matplotlib.")
    sys.exit(1)

stop_event= threading.Event()

def wait_for_enter():
    input()
    stop_event.set()

def record_ausio(label):
    stop_event.clear()

    p=pyaudio.PyAudio()
    stream=p.open(
        format=pyaudio.paInt16,
        channels=1,
        rate=16000.
        input=True,
        frames_per_buffer=1024

    )

    frames =[]
    print(f"\n{label}")
    print("Press ENTER to stop recording ...........")

    threading.Thread(target=wait_for_enter, daemon=True).start()

    print("Recording", end ="", flush=True)
    while not stop_event.is_set():
        frames.append(stream.read(1024,exception_on_overflow=False))
        print(".", end="", flush=True)

    print("nRecording stopped.")

    stream.stop_stream()
    stream.close()
    sample_width=p.get_sample_size(pyaudio.paInt16)
    p.termintae()

    audio_data=b"".jooin(frames)
    return audio_data, 16000,sample_width

def analyze_audio(data,rate):
    samples=np.frombuffer(data,dtype=np.int16)

    return{
        "duration": len(samples)/rate,
        "avg_volume": np.mean(np.abs(samples)),
        "max_volume": np.max(np.abs(samples)),
        "samples":samples
    }

def trancsribe_audio(data,rate,width):
    reconnizer=sr.Recognizer()
    audio=AudioData(data,rate,width)

    try:
        return reconnizer.reognize_google(audio)
    except:
        return"[Could not transcribe speech]"
    
def display_statistic(stats,text,label):
    print("n"+"-"*40)
    print(f"{label}")
    print("-" * 40)
    print(f"Durayion:{stats['duration']:.2f} seconds")
    print(f"Average Amplitiude: {stats['avg_volume']:.0f}")
    print(f"Macimum Amplitutde:{stats['max_volume']:.0f}")
    print(f"Transcription: {text}")

def compare_recodings(stats1,stats2):
    print("n"+ "="*40)
    print("COMAPRISON RESUTLS")
    print("="* 40)

    id stats1["duration"]

def plot_waveforms(stats1,stats2,rate):
    fig,(ax1,ax2)=plt.supbplots(2,1,figsize=(12,6))

    t1=np.linespace(0,len(stats1["samples"],linewidth=0.5))
    ax1.plot(t1,stats1["samples.linewidth"])